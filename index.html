<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ความคืบหน้างานตัดต่อ</title>
  <style>
    :root { --radius: 12px; --gap: 12px; --muted:#6b7280; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f8fafc; color: #0f172a; }
    header { background: #0f172a; color: #fff; padding: 16px; position: sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:18px; }
    header small { color:#cbd5e1; }
    main { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; max-width:480px; margin:0 auto; }
    .card { background:#fff; border-radius:var(--radius); padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.04); width:100%; }
    .progress { background:#e5e7eb; border-radius:999px; overflow:hidden; height:12px; margin:10px 0 6px; }
    .progress > div { background:#22c55e; height:100%; width:0; transition: width 0.3s ease-in-out; }
    .muted { color:var(--muted); font-size:12px; }
    .steps { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .step { display:flex; gap:8px; align-items:center; }
    input, textarea, select { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
    button { padding:10px 14px; border:0; border-radius:10px; background:#0ea5e9; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .outline { background:#fff; color:#0ea5e9; border:1px solid #0ea5e9; }
    .danger { background:#ef4444; }
    .tag { font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .comment { border-top:1px dashed #e5e7eb; padding-top:8px; margin-top:8px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>
<body>
<header>
  <h1>ความคืบหน้างานตัดต่อ</h1>
  <small>อัปเดตแบบเรียลไทม์ • ลูกค้าคอมเมนต์ได้ • ผู้ดูแลแก้ไขได้เท่านั้น</small>
  <div id="authBar"></div>
</header>

<main>
  <section id="adminPanel" class="card" style="display:none;">
    <h3>แผงผู้ดูแล</h3>
    <div class="row">
      <input id="taskName" type="text" placeholder="ชื่องาน เช่น Video Promo #1" />
      <button id="btnAddTask">+ เพิ่มงาน</button>
    </div>
    <small class="muted">เพิ่มงานใหม่ จากนั้นติ๊กขั้นตอนเพื่ออัปเดต % ความคืบหน้า</small>
  </section>

  <section id="tasks"></section>
</main>

<footer style="text-align:center; color:#6b7280; padding:24px;">© งานตัดต่อ — สถานะโปรเจกต์</footer>

<script type="module">
  /* ======= Firebase Config ======= */
  const firebaseConfig = {
    apiKey: "AIzaSyDD2IdEMyL432ppYtd4otGS6OqcnGwVTeg",
    authDomain: "video-progress-by-pakin.firebaseapp.com",
    projectId: "video-progress-by-pakin",
    storageBucket: "video-progress-by-pakin.firebasestorage.app",
    messagingSenderId: "451752819163",
    appId: "1:451752819163:web:a2ac1df08515d2891f8ffe"
  };

  const ADMIN_UIDS = new Set(["0tsXQx1oMddNxQVbkWj0D1wQRo52"]);

  const EDIT_STEPS = [
    "เลือกฟุตเทจ (Select Footage)",
    "จัดเรียงช็อต / ตัดเดดแอร์ (Rough Cut)",
    "ตัดต่อเนื้อหาให้กระชับ (Fine Cut)",
    "ปรับจังหวะ / ทรานซิชัน",
    "ใส่ซับไตเติล (Subtitles)",
    "ใส่กราฟิก / โลโก้ / ล่างชื่อ",
    "ใส่เพลง / SFX",
    "ปรับคัลเลอร์ (Color Grade)",
    "มิกซ์เสียง (Audio Mix)",
    "ตรวจรอบทีมงาน (Internal Review)",
    "ส่งพรีวิวลูกค้า (Client Review)",
    "แก้ไขตามคอมเมนต์ลูกค้า",
    "เรนเดอร์ไฟนอล (Final Export)",
    "ส่งมอบงาน / อัปโหลด (Delivery)",
  ];

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const el = (sel, root=document) => root.querySelector(sel);
  const els = (sel, root=document) => [...root.querySelectorAll(sel)];
  const tasksRoot = el('#tasks');
  const adminPanel = el('#adminPanel');
  const authBar = el('#authBar');

  const urlParams = new URLSearchParams(window.location.search);
  const showAdminLogin = urlParams.get('admin') === '1';

  function isAdmin(user) { return !!user && ADMIN_UIDS.has(user.uid); }
  function pctFromSteps(stepsState) {
    const total = EDIT_STEPS.length;
    const done = EDIT_STEPS.filter((_, i) => stepsState[i]).length;
    return Math.min(100, Math.max(0, Math.round((done / total)*100/10)*10));
  }

  function taskCard(id, data, userIsAdmin) {
    const pct = data.progress ?? 0;
    const wrapper = document.createElement('article');
    wrapper.className = 'card';
    wrapper.innerHTML = `
      <div>
        <strong>${data.name}</strong> <span class="tag">${pct}%</span>
        <div class="muted">อัปเดตล่าสุด: ${data.updatedAt?.toDate ? data.updatedAt.toDate().toLocaleString() : '-'}</div>
      </div>
      <div class="progress"><div style="width:${pct}%"></div></div>
      <details ${userIsAdmin ? 'open' : ''}>
        <summary>ขั้นตอนงานตัดต่อ</summary>
        <div class="steps" data-steps></div>
        ${userIsAdmin ? `<div class="row" style="margin-top:10px;">
          <button class="outline" data-save>บันทึกสถานะ</button>
          <button class="danger" data-delete>ลบงาน</button>
        </div>` : `<small class="muted">* เฉพาะผู้ดูแลเท่านั้น</small>`}
      </details>
      <div class="comment">
        <strong>คอมเมนต์จากลูกค้า</strong>
        <div data-comments></div>
        <div class="row">
          <input type="text" placeholder="ชื่อ (ไม่บังคับ)" data-c-name />
          <textarea rows="2" placeholder="พิมพ์คอมเมนต์" data-c-text></textarea>
          <button data-c-send>ส่งคอมเมนต์</button>
        </div>
      </div>
    `;

    const stepsHost = el('[data-steps]', wrapper);
    const states = data.steps ?? {};
    EDIT_STEPS.forEach((label,i)=>{
      const row = document.createElement('label');
      row.className='step';
      row.innerHTML=`<input type="checkbox" ${states[i]? 'checked':''} ${userIsAdmin?'':'disabled'} data-step="${i}" /> <div>${label}</div>`;
      stepsHost.appendChild(row);
    });

    if(userIsAdmin){
      el('[data-save]', wrapper).addEventListener('click', async()=>{
        const checkboxes=els('input[data-step]',wrapper);
        const newStates={};
        checkboxes.forEach(cb=>newStates[cb.dataset.step]=cb.checked);
        await updateDoc(doc(db,'tasks',id),{steps:newStates, progress:pctFromSteps(newStates), updatedAt:serverTimestamp()});
      });
      el('[data-delete]', wrapper).addEventListener('click', async()=>{
        if(!confirm('ลบงานนี้ถาวร?')) return;
        await deleteDoc(doc(db,'tasks',id));
      });
    }

    const cList = el('[data-comments]', wrapper);
    const cName = el('[data-c-name]', wrapper);
    const cText = el('[data-c-text]', wrapper);
    const cSend = el('[data-c-send]', wrapper);
    const commentsRef = collection(db,'tasks',id,'comments');
    onSnapshot(query(commentsRef, orderBy('createdAt','desc')), snap=>{
      cList.innerHTML='';
      snap.forEach(d=>{
        const v=d.data();
        const div=document.createElement('div');
        div.className='card'; div.style.padding='8px';
        div.innerHTML=`<div><strong>${v.author||'ลูกค้า'}</strong> <span class="muted">• ${v.createdAt?.toDate? v.createdAt.toDate().toLocaleString():''}</span></div>
          <div style="margin-top:4px;">${(v.text||'').replace(/\n/g,'<br>')}</div>`;
        cList.appendChild(div);
      });
    });
    cSend.addEventListener('click', async()=>{
      const author=(cName.value||'').trim();
      const text=(cText.value||'').trim();
      if(!text){ alert('กรุณาพิมพ์คอมเมนต์'); return;}
      await addDoc(commentsRef,{author,text,createdAt:serverTimestamp()});
      cText.value='';
    });

    return wrapper;
  }

  function renderAuthBar(user){
    authBar.innerHTML='';
    if(!showAdminLogin) return;
    const frag=document.createDocumentFragment();
    if(isAdmin(user)){
      const span=document.createElement('span'); span.textContent=`เข้าใช้ในโหมดผู้ดูแล: ${user.email}`; span.className='muted';
      const btn=document.createElement('button'); btn.textContent='ออกจากระบบ'; btn.addEventListener('click',()=>signOut(auth));
      frag.append(span,btn);
    } else {
      const email=document.createElement('input'); email.type='email'; email.placeholder='อีเมลผู้ดูแล';
      const pass=document.createElement('input'); pass.type='password'; pass.placeholder='รหัสผ่าน';
      const btn=document.createElement('button'); btn.textContent='เข้าสู่ระบบผู้ดูแล';
      btn.addEventListener('click', async()=>{ try{ await signInWithEmailAndPassword(auth,email.value,pass.value);} catch(e){alert('ล็อกอินไม่สำเร็จ:'+e.message);} });
      frag.append(email,pass,btn);
    }
    authBar.appendChild(frag);
  }

  onAuthStateChanged(auth,user=>{
    const admin=isAdmin(user);
    renderAuthBar(user);
    adminPanel.style.display=(admin && showAdminLogin)?'block':'none';
  });

  el('#btnAddTask').addEventListener('click', async()=>{
    const name=el('#taskName').value.trim();
    if(!name){ alert('กรุณากรอกชื่องาน'); return; }
    const stepsInit={}; EDIT_STEPS.forEach((_,i)=>stepsInit[i]=false);
    await addDoc(collection(db,'tasks'),{name,steps:stepsInit,progress:0,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
    el('#taskName').value='';
  });

  onSnapshot(query(collection(db,'tasks'), orderBy('createdAt','desc')), snap=>{
    tasksRoot.innerHTML='';
    const user=auth.currentUser;
    const admin=isAdmin(user);
    snap.forEach(d=>tasksRoot.appendChild(taskCard(d.id,d.data(),admin)));
  });
</script>
</body>
</html>